<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoogleMap現在地表示サンプル</title>
<link rel="stylesheet" href="/css/travel.css">
<script src="js/jquery-2.1.3.min.js"></script>
</head>

<body>



<div class="controls">
    <input type="text" id="destination-input" placeholder="目的地を入力">
    <button onclick="searchdestination()">検索</button>
    <button onclick="showattractions()">観光スポットを表示</button>
    <ul id="destination-list"></ul>
</div>
<div class="wrapper">
    <div id="js-map" class="map"></div>
</div>


<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_GEWw81WIE94mxkbD0GnlPvh93eayHBE&libraries=places,geometry&callback=initmap">
</script>

<script>

// マップオブジェクトとマーカーの配列
let map;
let mylocation;
let destinations = [];
let markers = [];

// GoogleMapライブラリを読み込んだ後に実行される初期化関数
function initmap() {
    navigator.geolocation.getCurrentPosition(success, error, options);
}

// 位置情報取得成功時の処理
function success(pos) {
    let nowlat = pos.coords.latitude;
    let nowlng = pos.coords.longitude;
    let nowlatlng = new google.maps.LatLng(nowlat, nowlng);

    let mapoptions = {
        zoom: 14,
        center: nowlatlng
    };

    map = new google.maps.Map(document.getElementById('js-map'), mapoptions);

    mylocation = new google.maps.Marker({
        map: map,
        position: mapoptions.center,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 22,
            fillColor: '#fff',
            fillOpacity: 0.8,
            strokeColor: "red",
            strokeWeight: 8,
        },
        label: {
            text: '現在地',
            color: 'orange',
            fontSize: '20px',
            fontWeight: '900'
        },
        draggable: false,
        map: map,
        animation: google.maps.Animation.DROP
    });
}

// 位置情報取得失敗時の処理
function error(err) {
    let msg = 'エラーが発生しました: ' + err;
    console.log(msg);
}

// 位置情報取得のオプション
let options = {
    enableHighAccuracy: false,
    timeout: 5000,
    maximumAge: 0
};

// 目的地を検索し、マップに表示する関数
function searchdestination() {
    const input = document.getElementById('destination-input').value;
    const geocoder = new google.maps.Geocoder();
    
    geocoder.geocode({ address: input }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            map.setCenter(location);
            
            const marker = new google.maps.Marker({
                map: map,
                position: location,
                title: input
            });
            
            destinations.push({ name: input, location: location });
            markers.push(marker);
            
            updatedestinationlist();
        } else {
            alert('目的地が見つかりませんでした: ' + status);
        }
    });
}

// 目的地リストを更新する関数
function updatedestinationlist() {
    const list = document.getElementById('destination-list');
    list.innerHTML = '';
    destinations.forEach((dest, index) => {
        const li = document.createElement('li');
        li.textContent = dest.name;
        li.onclick = () => map.panTo(dest.location);
        list.appendChild(li);
    });
}

// 観光スポットを表示する関数
function showattractions() {
    const service = new google.maps.places.PlacesService(map);
    destinations.forEach(dest => {
        const request = {
            location: dest.location,
            radius: '5000',
            type: ['tourist_attraction']
        };

        service.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                for (let i = 0; i < results.length; i++) {
                    createmarker(results[i]);
                }
            }
        });
    });
}

// 観光スポットのマーカーを作成する関数
function createmarker(place) {
    const marker = new google.maps.Marker({
        map: map,
        position: place.geometry.location,
        title: place.name,
        icon: {
            url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        }
    });

    const infowindow = new google.maps.InfoWindow({
        content: `<strong>${place.name}</strong><br>
                  評価: ${place.rating || 'N/A'}<br>
                  住所: ${place.vicinity}`
    });

    marker.addListener('click', () => {
        infowindow.open(map, marker);
    });

    markers.push(marker);
}



</script>
</body>
</html>